#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Tailscale
# Runs tailscale cert periodically
# ==============================================================================

# Request TLS certificate if configured
tailscale_cert() {
  if bashio::config.true 'request_cert'; then
    bashio::config.require 'domain_alias'
    /opt/tailscale cert \
      --cert-file "/ssl/$(bashio::config 'certfile')" \
      --key-file "/ssl/$(bashio::config 'keyfile')" \
      "$(bashio::info.hostname).$(bashio::config 'domain_alias')"
  fi
}

cert_err='Error running `tailscale cert`. Visit https://tailscale.com/kb/1153/enabling-https/ to setup HTTPS.'

if ! tailscale_cert; then
  bashio::exit.nok "$cert_err"
fi

bashio::log.info 'Starting Tailscale TLS certificate fetcher...'

while true; do
  if ! tailscale_cert; then
    bashio::log.error "$cert_err"
  fi
  sleep 86400 # Fetch certs once a day
done
